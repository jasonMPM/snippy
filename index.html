<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>to.ALWISP ‚Äî URL Shortener</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:       #0a0a0f;
  --surface:  #111118;
  --surface2: #181824;
  --surface3: #1e1e2e;
  --border:   rgba(255,255,255,0.07);
  --accent:   #00e5a0;
  --accent2:  #ff5e62;
  --accent3:  #7c6af7;
  --text:     #e8e8f0;
  --muted:    #6b6b80;
  --radius:   12px;
  --font-head: 'Orbitron', sans-serif;
  --font-mono: 'Share Tech Mono', monospace;
  --font-body: 'Barlow', sans-serif;
}
html { scroll-behavior: smooth; }
body { background: var(--bg); color: var(--text); font-family: var(--font-body); font-size: 15px; line-height: 1.6; min-height: 100vh; overflow-x: hidden; }
body::before {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
  background: radial-gradient(ellipse 80% 60% at 20% -10%,rgba(0,229,160,.07) 0%,transparent 60%),
              radial-gradient(ellipse 60% 50% at 90% 80%,rgba(255,94,98,.05) 0%,transparent 55%),
              radial-gradient(ellipse 40% 40% at 50% 50%,rgba(124,106,247,.04) 0%,transparent 60%);
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  position:sticky; top:0; z-index:100;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 40px; height:64px;
  background:rgba(10,10,15,.88); backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
}
.logo { font-family:var(--font-head); font-size:18px; font-weight:700; letter-spacing:.04em; text-decoration:none; color:var(--text); }
.logo-dot-text { color:var(--accent); text-shadow:0 0 12px var(--accent); }
.logo-alwisp   { text-transform:uppercase; }
nav { display:flex; gap:4px; }
nav button { background:transparent; border:none; color:var(--muted); cursor:pointer; font-family:var(--font-body); font-size:14px; padding:6px 16px; border-radius:8px; transition:all .2s; }
nav button:hover  { color:var(--text); background:var(--surface2); }
nav button.active { color:var(--accent); background:rgba(0,229,160,.08); }
.header-right { display:flex; align-items:center; gap:10px; }
.user-badge {
  display:flex; align-items:center; gap:8px;
  background:var(--surface2); border:1px solid var(--border);
  border-radius:8px; padding:5px 12px; font-size:13px;
  font-family:var(--font-mono);
}
.user-badge .admin-tag { color:var(--accent); font-size:10px; letter-spacing:.06em; }
.btn-logout { background:transparent; border:1px solid var(--border); color:var(--muted); font-family:var(--font-mono); font-size:12px; padding:5px 12px; border-radius:8px; cursor:pointer; transition:all .2s; }
.btn-logout:hover { border-color:var(--accent2); color:var(--accent2); }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
main { position:relative; z-index:1; }
.view { display:none; padding:40px; max-width:980px; margin:0 auto; }
.view.active { display:block; animation:fadeIn .25s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero { text-align:center; padding:60px 20px 40px; }
.hero h1 { font-family:var(--font-head); font-size:clamp(42px,8vw,88px); font-weight:900; line-height:1; letter-spacing:.06em; margin-bottom:40px; text-transform:lowercase; }
.hero-to   { color:var(--text); }
.hero-dot  { color:var(--accent); text-shadow:0 0 20px var(--accent),0 0 40px rgba(0,229,160,.4); }
.hero-alwisp { text-transform:uppercase; background:linear-gradient(135deg,#fff 0%,var(--accent) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }

/* ‚îÄ‚îÄ CARDS / PANELS ‚îÄ‚îÄ */
.shorten-card { background:var(--surface); border:1px solid var(--border); border-radius:20px; padding:32px; max-width:720px; margin:0 auto; box-shadow:0 24px 64px rgba(0,0,0,.4); }
.panel { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:24px; }
.panel h3 { font-family:var(--font-head); font-size:13px; font-weight:700; margin-bottom:18px; letter-spacing:.04em; }

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.input-group { display:flex; gap:10px; margin-bottom:20px; }
.input-group input, .field-input {
  background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius);
  color:var(--text); font-family:var(--font-mono); font-size:13px; padding:12px 16px; outline:none;
  transition:border-color .2s,box-shadow .2s; width:100%;
}
.input-group input { flex:1; }
.input-group input:focus, .field-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,229,160,.1); }
.input-group input::placeholder, .field-input::placeholder { color:var(--muted); }
.field-label { font-size:11px; font-family:var(--font-mono); letter-spacing:.08em; color:var(--muted); margin-bottom:5px; display:block; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-primary { background:var(--accent); color:#000; border:none; cursor:pointer; font-family:var(--font-head); font-weight:700; font-size:12px; letter-spacing:.04em; padding:12px 22px; border-radius:var(--radius); transition:all .2s; white-space:nowrap; }
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,229,160,.35); }
.btn-primary:disabled { opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
.btn-sm { border:1px solid var(--border); background:var(--surface2); color:var(--text); font-size:11px; font-family:var(--font-mono); padding:6px 14px; border-radius:8px; cursor:pointer; transition:all .2s; }
.btn-sm:hover { border-color:var(--accent); color:var(--accent); }
.btn-sm.danger:hover { border-color:var(--accent2); color:var(--accent2); }
.btn-sm.save  { background:rgba(0,229,160,.1); border-color:rgba(0,229,160,.3); color:var(--accent); }

/* ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.75); backdrop-filter:blur(8px);
  display:flex; align-items:center; justify-content:center; z-index:200;
  animation:fadeIn .2s ease;
}
.modal-overlay.hidden { display:none; }
.modal {
  background:var(--surface); border:1px solid var(--border);
  border-radius:20px; padding:40px; width:100%; max-width:420px;
  box-shadow:0 32px 80px rgba(0,0,0,.6);
  animation:modalIn .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes modalIn { from{opacity:0;transform:scale(.94) translateY(10px)} to{opacity:1;transform:none} }
.modal-logo { font-family:var(--font-head); font-size:22px; font-weight:900; text-align:center; margin-bottom:28px; }
.modal-tabs { display:flex; background:var(--surface2); border-radius:10px; padding:4px; margin-bottom:24px; }
.modal-tab { flex:1; padding:8px; border:none; background:transparent; color:var(--muted); font-family:var(--font-mono); font-size:12px; cursor:pointer; border-radius:7px; transition:all .2s; }
.modal-tab.active { background:var(--surface3); color:var(--accent); }
.modal-form { display:none; flex-direction:column; gap:14px; }
.modal-form.active { display:flex; }
.modal-form label { display:flex; flex-direction:column; gap:5px; font-size:11px; font-family:var(--font-mono); color:var(--muted); letter-spacing:.06em; }
.modal-form input { background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:var(--font-mono); font-size:13px; padding:11px 14px; outline:none; transition:border-color .2s; }
.modal-form input:focus { border-color:var(--accent); }
.modal-err { color:var(--accent2); font-size:12px; font-family:var(--font-mono); display:none; }
.modal-err.show { display:block; }
.invite-note { font-size:12px; color:var(--muted); font-family:var(--font-mono); text-align:center; }

/* ‚îÄ‚îÄ STATS STRIP ‚îÄ‚îÄ */
.stats-strip { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:28px; }
.stat-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; position:relative; overflow:hidden; }
.stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,var(--accent),transparent); }
.stat-value { font-family:var(--font-head); font-size:28px; font-weight:900; line-height:1; margin-bottom:4px; background:linear-gradient(135deg,var(--text),var(--muted)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
.stat-label { font-size:10px; color:var(--muted); font-family:var(--font-mono); letter-spacing:.06em; }

/* ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ */
.toolbar { display:flex; align-items:center; gap:10px; margin-bottom:18px; flex-wrap:wrap; }
.search-wrap { flex:1; min-width:180px; position:relative; }
.search-wrap svg { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted); pointer-events:none; }
.search-input { width:100%; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-family:var(--font-mono); font-size:13px; padding:10px 14px 10px 38px; outline:none; transition:border-color .2s; }
.search-input:focus { border-color:var(--accent); }
.search-input::placeholder { color:var(--muted); }
.tag-filter-list { display:flex; gap:5px; flex-wrap:wrap; }
.tag-filter-btn { background:var(--surface); border:1px solid var(--border); color:var(--muted); font-family:var(--font-mono); font-size:11px; padding:5px 11px; border-radius:6px; cursor:pointer; transition:all .2s; }
.tag-filter-btn:hover  { border-color:var(--accent3); color:#a89cf7; }
.tag-filter-btn.active { background:rgba(124,106,247,.1); border-color:rgba(124,106,247,.4); color:#a89cf7; }

/* ‚îÄ‚îÄ WORKSPACE SELECTOR ‚îÄ‚îÄ */
.ws-row { display:flex; align-items:center; gap:8px; margin-bottom:18px; flex-wrap:wrap; }
.ws-btn { background:var(--surface2); border:1px solid var(--border); color:var(--muted); font-family:var(--font-mono); font-size:11px; padding:5px 12px; border-radius:6px; cursor:pointer; transition:all .2s; }
.ws-btn:hover  { border-color:var(--accent); color:var(--accent); }
.ws-btn.active { background:rgba(0,229,160,.08); border-color:rgba(0,229,160,.3); color:var(--accent); }

/* ‚îÄ‚îÄ LINK ITEMS ‚îÄ‚îÄ */
.links-list { display:flex; flex-direction:column; gap:8px; }
.link-item { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; transition:border-color .2s; }
.link-item:hover   { border-color:rgba(0,229,160,.15); }
.link-item.expanded{ border-color:rgba(0,229,160,.25); }
.link-row { padding:14px 18px; display:flex; align-items:center; gap:12px; cursor:pointer; user-select:none; }
.link-code { font-family:var(--font-head); font-size:14px; font-weight:700; color:var(--accent); min-width:72px; flex-shrink:0; }
.link-details { flex:1; overflow:hidden; }
.link-title    { font-size:13px; margin-bottom:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.link-original { font-family:var(--font-mono); font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.link-tags     { display:flex; gap:4px; flex-wrap:wrap; margin-top:3px; }
.link-tag { background:rgba(124,106,247,.1); border:1px solid rgba(124,106,247,.25); color:#a89cf7; font-family:var(--font-mono); font-size:10px; padding:1px 6px; border-radius:3px; }
.ws-tag   { background:rgba(0,229,160,.08); border:1px solid rgba(0,229,160,.2); color:var(--accent); font-family:var(--font-mono); font-size:10px; padding:1px 6px; border-radius:3px; }
.link-meta { display:flex; align-items:center; gap:8px; flex-shrink:0; }
.link-clicks { font-family:var(--font-mono); font-size:11px; color:var(--muted); white-space:nowrap; }
.link-clicks strong { color:var(--text); }
.link-chevron { color:var(--muted); transition:transform .25s; flex-shrink:0; }
.link-item.expanded .link-chevron { transform:rotate(180deg); }

/* ‚îÄ‚îÄ EXPANDED PANEL ‚îÄ‚îÄ */
.link-expanded { display:none; border-top:1px solid var(--border); padding:20px; background:var(--surface2); animation:expandIn .2s ease; }
@keyframes expandIn { from{opacity:0} to{opacity:1} }
.link-item.expanded .link-expanded { display:block; }
.expanded-actions { display:flex; gap:8px; margin-bottom:18px; flex-wrap:wrap; }
.edit-form { background:var(--surface3); border:1px solid var(--border); border-radius:10px; padding:18px; margin-bottom:18px; display:none; }
.edit-form.open { display:block; }
.edit-form h4 { font-family:var(--font-mono); font-size:11px; color:var(--muted); letter-spacing:.08em; margin-bottom:14px; }
.edit-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
.edit-full { grid-column:1/-1; }
.edit-actions { display:flex; gap:8px; justify-content:flex-end; }

/* ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ */
.analytics-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
.analytics-title  { font-family:var(--font-mono); font-size:11px; color:var(--muted); letter-spacing:.08em; }
.analytics-days   { display:flex; gap:4px; }
.day-btn { background:var(--surface3); border:1px solid var(--border); color:var(--muted); font-family:var(--font-mono); font-size:11px; padding:3px 9px; border-radius:5px; cursor:pointer; transition:all .2s; }
.day-btn:hover  { border-color:var(--accent); color:var(--accent); }
.day-btn.active { background:rgba(0,229,160,.1); border-color:rgba(0,229,160,.3); color:var(--accent); }
.chart-wrap { background:var(--surface3); border:1px solid var(--border); border-radius:10px; padding:14px; margin-bottom:14px; }
.chart-canvas { width:100%; height:90px; display:block; }
.breakdown-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
.breakdown-card { background:var(--surface3); border:1px solid var(--border); border-radius:10px; padding:12px; }
.breakdown-card h5 { font-family:var(--font-mono); font-size:10px; color:var(--muted); letter-spacing:.08em; margin-bottom:8px; }
.breakdown-row { display:flex; align-items:center; gap:6px; margin-bottom:5px; }
.breakdown-label { font-family:var(--font-mono); font-size:11px; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.breakdown-bar-wrap { flex:2; height:4px; background:var(--surface2); border-radius:2px; overflow:hidden; }
.breakdown-bar { height:100%; border-radius:2px; background:var(--accent); transition:width .4s; }
.breakdown-count { font-family:var(--font-mono); font-size:10px; color:var(--muted); min-width:24px; text-align:right; }

/* ‚îÄ‚îÄ SECTION HEAD ‚îÄ‚îÄ */
.section-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
.section-title { font-family:var(--font-head); font-size:18px; font-weight:700; }

/* ‚îÄ‚îÄ ADVANCED ‚îÄ‚îÄ */
.advanced-toggle { color:var(--muted); font-size:12px; cursor:pointer; display:flex; align-items:center; gap:6px; margin-bottom:14px; user-select:none; transition:color .2s; width:fit-content; }
.advanced-toggle:hover { color:var(--text); }
.advanced-toggle svg { transition:transform .2s; }
.advanced-toggle.open svg { transform:rotate(90deg); }
.advanced-fields { display:none; gap:10px; }
.advanced-fields.open { display:grid; grid-template-columns:1fr 1fr; }

/* ‚îÄ‚îÄ TAG INPUT ‚îÄ‚îÄ */
.tag-input-wrap { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:8px 12px; display:flex; flex-wrap:wrap; gap:5px; align-items:center; transition:border-color .2s; cursor:text; }
.tag-input-wrap:focus-within { border-color:var(--accent); }
.tag-pill { background:rgba(124,106,247,.15); border:1px solid rgba(124,106,247,.3); color:#a89cf7; font-family:var(--font-mono); font-size:11px; padding:2px 8px; border-radius:4px; display:flex; align-items:center; gap:4px; }
.tag-pill button { background:none; border:none; color:inherit; cursor:pointer; font-size:13px; line-height:1; padding:0; opacity:.6; }
.tag-pill button:hover { opacity:1; }
.tag-input-inner { background:none; border:none; color:var(--text); font-family:var(--font-mono); font-size:13px; outline:none; min-width:80px; flex:1; }
.tag-input-inner::placeholder { color:var(--muted); }

/* ‚îÄ‚îÄ RESULT CARD ‚îÄ‚îÄ */
.result-card { background:linear-gradient(135deg,rgba(0,229,160,.06),rgba(0,180,216,.03)); border:1px solid rgba(0,229,160,.2); border-radius:16px; padding:22px; margin-top:18px; display:none; animation:slideIn .4s cubic-bezier(.34,1.56,.64,1); }
@keyframes slideIn { from{opacity:0;transform:scale(.96) translateY(8px)} to{opacity:1;transform:none} }
.result-card.visible { display:block; }
.result-top { display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap; }
.result-short-url { font-family:var(--font-mono); font-size:20px; font-weight:500; color:var(--accent); text-decoration:none; letter-spacing:-.5px; word-break:break-all; }
.result-short-url:hover { text-decoration:underline; }
.result-original { font-size:11px; color:var(--muted); font-family:var(--font-mono); margin-top:4px; word-break:break-all; }
.result-actions { display:flex; gap:7px; flex-shrink:0; }
.result-qr { margin-top:18px; display:flex; align-items:center; gap:20px; padding-top:18px; border-top:1px solid var(--border); flex-wrap:wrap; }
.qr-img-wrap { background:#fff; border-radius:10px; padding:10px; flex-shrink:0; box-shadow:0 4px 20px rgba(0,0,0,.3); }
.qr-img-wrap img { display:block; width:100px; height:100px; }
.qr-info h4 { font-family:var(--font-head); font-size:12px; margin-bottom:5px; }
.qr-info p  { font-size:11px; color:var(--muted); margin-bottom:10px; }

/* ‚îÄ‚îÄ ADMIN / SETTINGS PANELS ‚îÄ‚îÄ */
.tabs { display:flex; background:var(--surface2); border-radius:10px; padding:4px; margin-bottom:22px; gap:2px; }
.tab-btn { flex:1; padding:8px; border:none; background:transparent; color:var(--muted); font-family:var(--font-mono); font-size:11px; cursor:pointer; border-radius:7px; transition:all .2s; letter-spacing:.04em; }
.tab-btn.active { background:var(--surface3); color:var(--accent); }
.tab-content { display:none; }
.tab-content.active { display:block; }
.data-table { width:100%; border-collapse:collapse; font-size:13px; }
.data-table th { font-family:var(--font-mono); font-size:10px; color:var(--muted); letter-spacing:.08em; text-align:left; padding:8px 12px; border-bottom:1px solid var(--border); }
.data-table td { padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.04); font-family:var(--font-mono); font-size:12px; }
.data-table tr:hover td { background:rgba(255,255,255,.02); }
.badge { display:inline-block; font-family:var(--font-mono); font-size:10px; padding:2px 8px; border-radius:4px; }
.badge.admin { background:rgba(0,229,160,.1); border:1px solid rgba(0,229,160,.25); color:var(--accent); }
.badge.member{ background:rgba(124,106,247,.1); border:1px solid rgba(124,106,247,.25); color:#a89cf7; }
.badge.inactive{ background:rgba(255,94,98,.1); border:1px solid rgba(255,94,98,.25); color:var(--accent2); }

/* ‚îÄ‚îÄ KEY CARD ‚îÄ‚îÄ */
.key-card { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:14px 18px; display:flex; align-items:center; gap:12px; margin-bottom:8px; }
.key-prefix { font-family:var(--font-mono); font-size:13px; flex:1; }
.key-label  { font-size:12px; color:var(--muted); }
.key-reveal { background:rgba(0,229,160,.1); border:1px solid rgba(0,229,160,.25); color:var(--accent); font-family:var(--font-mono); font-size:12px; padding:6px 16px; border-radius:8px; margin:12px 0; word-break:break-all; display:none; }
.key-reveal.show { display:block; }

/* ‚îÄ‚îÄ INVITE CARD ‚îÄ‚îÄ */
.invite-card { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:14px 18px; display:flex; align-items:center; gap:12px; margin-bottom:8px; }
.invite-url { font-family:var(--font-mono); font-size:12px; flex:1; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.invite-used { color:var(--accent2); font-size:11px; font-family:var(--font-mono); }
.invite-exp  { color:var(--muted);   font-size:11px; font-family:var(--font-mono); }

/* ‚îÄ‚îÄ QR VIEW ‚îÄ‚îÄ */
.qr-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
.qr-preview-panel { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px; min-height:280px; }
.qr-preview-img { background:#fff; border-radius:12px; padding:14px; box-shadow:0 8px 32px rgba(0,0,0,.4); }
.qr-preview-img img { display:block; width:200px; height:200px; }
.qr-placeholder { width:200px; height:200px; border:2px dashed var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px; font-family:var(--font-mono); text-align:center; padding:20px; }
.color-row { display:flex; gap:12px; margin-bottom:14px; }
.color-field { flex:1; }
.color-field label { font-size:11px; color:var(--muted); font-family:var(--font-mono); display:block; margin-bottom:5px; letter-spacing:.06em; }
.color-input-wrap { display:flex; align-items:center; gap:8px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:8px 12px; }
input[type="color"] { width:24px; height:24px; border:none; border-radius:4px; padding:0; cursor:pointer; background:none; flex-shrink:0; }
.color-hex { font-family:var(--font-mono); font-size:13px; background:none; border:none; color:var(--text); width:70px; outline:none; }
input[type="range"] { -webkit-appearance:none; width:100%; height:4px; background:var(--surface2); border-radius:2px; outline:none; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; background:var(--accent); border-radius:50%; cursor:pointer; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast-container { position:fixed; bottom:24px; right:24px; display:flex; flex-direction:column; gap:8px; z-index:999; }
.toast { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:11px 16px; font-size:12px; font-family:var(--font-mono); display:flex; align-items:center; gap:8px; box-shadow:0 8px 24px rgba(0,0,0,.4); animation:toastIn .3s cubic-bezier(.34,1.56,.64,1); }
@keyframes toastIn { from{opacity:0;transform:translateX(16px) scale(.95)} to{opacity:1;transform:none} }
.toast.success { border-color:rgba(0,229,160,.3); }
.toast.error   { border-color:rgba(255,94,98,.3); }

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.empty-state { text-align:center; padding:50px 20px; color:var(--muted); }
.empty-state .empty-icon { font-size:40px; margin-bottom:14px; opacity:.3; }
.empty-state p { font-family:var(--font-mono); font-size:12px; }
.spinner { width:14px; height:14px; border:2px solid rgba(0,0,0,.2); border-top-color:#000; border-radius:50%; animation:spin .7s linear infinite; display:inline-block; }
@keyframes spin { to{transform:rotate(360deg)} }
.divider { border:none; border-top:1px solid var(--border); margin:20px 0; }
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }

@media(max-width:700px) {
  header { padding:0 16px; }
  .view  { padding:16px 12px; }
  .stats-strip { grid-template-columns:1fr 1fr; }
  .input-group { flex-direction:column; }
  .advanced-fields.open,.edit-grid,.qr-grid,.breakdown-grid,.grid-2 { grid-template-columns:1fr; }
}

/* ‚îÄ‚îÄ PHASE 4: QR STYLE SELECTOR ‚îÄ‚îÄ */
.style-selector { display:flex; gap:6px; flex-wrap:wrap; }
.style-btn { background:var(--surface2); border:1px solid var(--border); color:var(--muted); font-family:var(--font-mono); font-size:11px; padding:6px 12px; border-radius:6px; cursor:pointer; transition:all .2s; }
.style-btn:hover { border-color:var(--accent3); color:#a89cf7; }
.style-btn.active { background:rgba(124,106,247,.1); border-color:rgba(124,106,247,.4); color:#a89cf7; }

/* ‚îÄ‚îÄ PHASE 4: LOGO UPLOAD ‚îÄ‚îÄ */
.logo-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

/* ‚îÄ‚îÄ PHASE 4: BULK ACTION BAR ‚îÄ‚îÄ */
.bulk-bar { display:none; align-items:center; gap:8px; padding:10px 14px; background:var(--surface2); border:1px solid rgba(0,229,160,.2); border-radius:var(--radius); margin-bottom:14px; flex-wrap:wrap; }
.bulk-count { font-family:var(--font-mono); font-size:12px; color:var(--accent); flex:1; min-width:80px; }

/* ‚îÄ‚îÄ PHASE 4: IMPORT PANEL ‚îÄ‚îÄ */
.import-panel { display:none; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin-bottom:14px; }
.import-panel.open { display:block; animation:fadeIn .2s ease; }
.import-panel textarea { width:100%; background:var(--surface3); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:var(--font-mono); font-size:12px; padding:12px; outline:none; resize:vertical; min-height:100px; transition:border-color .2s; box-sizing:border-box; }
.import-panel textarea:focus { border-color:var(--accent); }
.import-result { font-family:var(--font-mono); font-size:11px; color:var(--muted); margin-top:8px; white-space:pre-wrap; }

/* ‚îÄ‚îÄ PHASE 4: SELECT CHECKBOX ‚îÄ‚îÄ */
.select-check { display:none; align-items:center; margin-right:6px; flex-shrink:0; }
.link-checkbox { width:15px; height:15px; cursor:pointer; accent-color:var(--accent); }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ -->
<div class="modal-overlay" id="auth-modal">
  <div class="modal">
    <div class="modal-logo">
      <span style="color:var(--text)">to</span><span style="color:var(--accent);text-shadow:0 0 12px var(--accent)">.</span><span style="text-transform:uppercase">ALWISP</span>
    </div>
    <div class="modal-form active" id="form-login">
      <label>PASSWORD<input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></label>
      <div class="modal-err" id="login-err"></div>
      <button class="btn-primary" onclick="doLogin()" style="width:100%">Login</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<header>
  <a class="logo" href="/">
    <span class="logo-to">to</span><span class="logo-dot-text">.</span><span class="logo-alwisp">ALWISP</span>
  </a>
  <nav>
    <button class="active" data-view="home">Shorten</button>
    <button data-view="dashboard">Dashboard</button>
    <button data-view="qr">QR Codes</button>
  </nav>
  <div class="header-right">
    <button class="btn-logout" id="logout-btn" style="display:none" onclick="doLogout()">Logout</button>
  </div>
</header>

<main>

<!-- ‚îÄ‚îÄ HOME ‚îÄ‚îÄ -->
<div class="view active" id="view-home">
  <div class="hero">
    <h1><span class="hero-to">to</span><span class="hero-dot">.</span><span class="hero-alwisp">ALWISP</span></h1>
    <div class="shorten-card">
      <div class="input-group">
        <input type="url" id="url-input" placeholder="https://your-long-url.com/goes/here" autocomplete="off" spellcheck="false">
        <button class="btn-primary" id="shorten-btn"><span id="shorten-label">Snip it ‚Üí</span></button>
      </div>
      <div class="advanced-toggle" id="adv-toggle">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M4.5 2L8.5 6L4.5 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        Advanced options
      </div>
      <div class="advanced-fields" id="adv-fields">
        <div><label class="field-label">CUSTOM CODE</label><input class="field-input" id="custom-code" placeholder="e.g. mylink" maxlength="20"></div>
        <div><label class="field-label">TITLE (optional)</label><input class="field-input" id="link-title" placeholder="e.g. My Homepage"></div>
        <div><label class="field-label">EXPIRY DATE</label><input class="field-input" type="date" id="link-expiry"></div>
        <div style="grid-column:1/-1">
          <label class="field-label">TAGS (Enter or comma)</label>
          <div class="tag-input-wrap" id="tag-input-wrap">
            <input class="tag-input-inner" id="tag-input" placeholder="e.g. marketing, social">
          </div>
        </div>
      </div>
      <div class="result-card" id="result-card">
        <div class="result-top">
          <div>
            <a class="result-short-url" id="result-url" href="#" target="_blank"></a>
            <div class="result-original" id="result-original"></div>
          </div>
          <div class="result-actions">
            <button class="btn-sm" id="copy-btn">Copy</button>
            <button class="btn-sm" id="dl-qr-btn">‚Üì QR</button>
          </div>
        </div>
        <div class="result-qr">
          <div class="qr-img-wrap"><img id="result-qr-img" src="" alt="QR"></div>
          <div class="qr-info">
            <h4>QR Code Ready</h4>
            <p>Download or customize in the QR tab.</p>
            <button class="btn-sm" id="customize-qr-btn">Customize QR ‚Üí</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
<div class="view" id="view-dashboard">
  <div class="stats-strip">
    <div class="stat-card"><div class="stat-value" id="stat-total">‚Äî</div><div class="stat-label">TOTAL LINKS</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-clicks">‚Äî</div><div class="stat-label">TOTAL CLICKS</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-7d">‚Äî</div><div class="stat-label">CLICKS / 7D</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-avg">‚Äî</div><div class="stat-label">AVG / LINK</div></div>
  </div>

  <div class="toolbar">
    <div class="search-wrap">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><circle cx="6.5" cy="6.5" r="5.5" stroke="currentColor" stroke-width="1.5"/><path d="M11 11L14.5 14.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      <input class="search-input" id="search-input" placeholder="Search links, URLs, titles...">
    </div>
    <div class="tag-filter-list" id="tag-filter-list"></div>
    <button class="btn-sm" onclick="loadDashboard()">‚Üª</button>
    <button class="btn-sm" id="select-btn" onclick="toggleSelectMode()">‚ä° Select</button>
    <button class="btn-sm" onclick="exportCSV()">‚Üì Export</button>
    <button class="btn-sm" onclick="toggleImport()">‚Üë Import</button>
  </div>

  <div class="import-panel" id="import-panel">
    <div style="font-family:var(--font-mono);font-size:11px;color:var(--muted);margin-bottom:8px;letter-spacing:.06em">CSV IMPORT ‚Äî columns: <code>url</code> (required), <code>custom_code</code>, <code>title</code>, <code>tags</code>, <code>expires_at</code></div>
    <textarea id="import-csv" placeholder="url,title,tags&#10;https://example.com,My Link,tag1&#10;https://another.com,,"></textarea>
    <div style="display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap">
      <button class="btn-sm" onclick="document.getElementById('import-file').click()">üìé From file</button>
      <input type="file" id="import-file" accept=".csv,text/csv" style="display:none">
      <button class="btn-primary" id="import-btn" onclick="doImport()" style="padding:8px 18px">Import</button>
    </div>
    <div class="import-result" id="import-result"></div>
  </div>

  <div class="bulk-bar" id="bulk-bar">
    <span class="bulk-count" id="bulk-count">0 selected</span>
    <button class="btn-sm" onclick="selectAll()">Select all</button>
    <button class="btn-sm danger" onclick="bulkDelete()">‚úï Delete</button>
    <button class="btn-sm" onclick="bulkTag()">‚äï Tag</button>
    <button class="btn-sm" onclick="bulkExpire()">‚è± Set Expiry</button>
    <button class="btn-sm" onclick="toggleSelectMode()">Cancel</button>
  </div>

  <div class="links-list" id="links-list">
    <div class="empty-state"><div class="empty-icon">üîó</div><p>Loading...</p></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ QR ‚îÄ‚îÄ -->
<div class="view" id="view-qr">
  <div class="section-head" style="margin-bottom:24px">
    <div><div class="section-title">QR Generator</div><div style="color:var(--muted);font-size:13px;margin-top:3px">Generate and customize QR codes for any URL</div></div>
  </div>
  <div class="qr-grid">
    <div class="panel">
      <h3>Configure</h3>
      <label class="field-label">URL</label>
      <input class="field-input" id="qr-url-input" placeholder="https://example.com" style="margin-bottom:18px">
      <div class="color-row">
        <div class="color-field"><label>FOREGROUND</label><div class="color-input-wrap"><input type="color" id="qr-fg-picker" value="#000000"><input class="color-hex" id="qr-fg-hex" value="000000" maxlength="6"></div></div>
        <div class="color-field"><label>BACKGROUND</label><div class="color-input-wrap"><input type="color" id="qr-bg-picker" value="#ffffff"><input class="color-hex" id="qr-bg-hex" value="ffffff" maxlength="6"></div></div>
      </div>
      <div style="margin-bottom:18px"><label class="field-label">SIZE: <span id="qr-size-label">300px</span></label><input type="range" id="qr-size" min="150" max="600" value="300" step="50"></div>
      <div style="margin-bottom:18px">
        <label class="field-label">DOT STYLE</label>
        <div class="style-selector" id="qr-style-selector">
          <button class="style-btn active" data-style="square">‚ñ† Square</button>
          <button class="style-btn" data-style="rounded">‚ñ£ Rounded</button>
          <button class="style-btn" data-style="dots">‚óè Dots</button>
          <button class="style-btn" data-style="vertical">‚ñê V-Bars</button>
          <button class="style-btn" data-style="horizontal">‚ñ¨ H-Bars</button>
        </div>
      </div>
      <div style="margin-bottom:18px">
        <label class="field-label">LOGO / ICON <span style="font-weight:400;color:var(--muted)">(optional ‚Äî centered overlay)</span></label>
        <div class="logo-row">
          <button class="btn-sm" onclick="document.getElementById('qr-logo-input').click()">‚Üë Upload Logo</button>
          <span id="qr-logo-name" style="font-family:var(--font-mono);font-size:11px;color:var(--muted)"></span>
          <button class="btn-sm danger" id="qr-logo-clear" style="display:none" onclick="clearQrLogo()">‚úï Remove</button>
        </div>
        <input type="file" id="qr-logo-input" accept="image/*" style="display:none">
      </div>
      <button class="btn-primary" id="qr-generate-btn" style="width:100%">Generate QR Code</button>
    </div>
    <div class="panel qr-preview-panel">
      <h3 style="align-self:flex-start;width:100%">Preview</h3>
      <div id="qr-preview-wrap"><div class="qr-placeholder">Enter a URL and click Generate</div></div>
      <div id="qr-dl-row" style="display:none;flex-direction:column;align-items:center;gap:8px;width:100%">
        <a class="btn-primary" id="qr-download-link" download="qrcode.png" style="text-decoration:none;display:inline-block;text-align:center">‚Üì Download PNG</a>
        <div style="font-size:11px;color:var(--muted);font-family:var(--font-mono)">Right-click to save</div>
      </div>
    </div>
  </div>
</div>


</main>

<div class="toast-container" id="toast-container"></div>

<!-- Debug panel (only visible when ?debug=1 is in the URL) -->
<div id="debug-panel" style="display:none;position:fixed;bottom:0;left:0;right:0;background:#1a1a2e;border-top:2px solid #e040fb;padding:12px 16px;font-family:monospace;font-size:11px;color:#ccc;z-index:9999;max-height:220px;overflow-y:auto;">
  <strong style="color:#e040fb">DEBUG PANEL</strong>
  <button onclick="document.getElementById('debug-panel').style.display='none'" style="float:right;background:#333;border:none;color:#fff;cursor:pointer;padding:2px 8px;border-radius:4px">‚úï</button>
  <br><br>
  <div id="dbg-content">Loading...</div>
  <br>
  <button onclick="runDebug()" style="background:#333;border:1px solid #555;color:#ccc;cursor:pointer;padding:4px 10px;border-radius:4px;font-size:11px">Refresh</button>
  <button onclick="testStats()" style="background:#333;border:1px solid #555;color:#ccc;cursor:pointer;padding:4px 10px;border-radius:4px;font-size:11px;margin-left:6px">Test /api/stats</button>
  <pre id="dbg-extra" style="color:#aaa;margin-top:8px;white-space:pre-wrap;"></pre>
</div>

<script>
const BASE = window.location.origin;
let loggedIn     = false;
let allTags      = [];
let activeTag    = null;
let tagInputTags = [];
let searchTimer  = null;
let selectMode   = false;
let selectedCodes = new Set();
let qrStyle      = 'square';
let qrLogoBase64 = null;

async function authFetch(url, opts = {}) {
  const resp = await fetch(url, {
    ...opts,
    credentials: 'include',
    headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) },
  });
  if (resp.status === 401) {
    loggedIn = false;
    onLoggedOut();
  }
  return resp;
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('nav button[data-view]').forEach(btn => {
  btn.addEventListener('click', () => showView(btn.dataset.view));
});

function showView(name) {
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const btn = document.querySelector(`[data-view="${name}"]`);
  if (btn) btn.classList.add('active');
  document.getElementById(`view-${name}`)?.classList.add('active');
  if (name === 'dashboard') loadDashboard();
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${type==='success'?'‚úì':'‚úï'}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ‚îÄ‚îÄ Auth Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAuthModal() { document.getElementById('auth-modal').classList.remove('hidden'); }
function hideAuthModal() { document.getElementById('auth-modal').classList.add('hidden'); }

async function doLogin() {
  const password = document.getElementById('login-password').value;
  const errEl    = document.getElementById('login-err');
  errEl.classList.remove('show');
  try {
    const resp = await fetch(`${BASE}/api/auth/login`, {
      method:'POST', credentials:'include', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({password})
    });
    const d = await resp.json();
    if (!resp.ok) { errEl.textContent = d.error; errEl.classList.add('show'); return; }
    loggedIn = true;
    onLoggedIn();
  } catch(e) { errEl.textContent='Network error'; errEl.classList.add('show'); }
}

async function doLogout() {
  await fetch(`${BASE}/api/auth/logout`, {method:'POST', credentials:'include'}).catch(()=>{});
  loggedIn = false;
  onLoggedOut();
}

function onLoggedIn() {
  hideAuthModal();
  document.getElementById('logout-btn').style.display = 'block';
  loadDashboard();
}

function onLoggedOut() {
  document.getElementById('logout-btn').style.display = 'none';
  showView('home');
  showAuthModal();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function init() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('error') === 'not_found') toast('Link not found', 'error');
  if (params.get('error') === 'expired')   toast('Link has expired', 'error');

  try {
    const resp = await fetch(`${BASE}/api/auth/me`, {credentials:'include'});
    if (resp.ok) { loggedIn = true; onLoggedIn(); return; }
  } catch(e) {}

  showAuthModal();
})();

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  await Promise.all([loadStats(), loadTags()]);
  await loadLinks();
}

async function loadStats() {
  try {
    const d = await (await authFetch(`${BASE}/api/stats`)).json();
    document.getElementById('stat-total').textContent  = d.total_links.toLocaleString();
    document.getElementById('stat-clicks').textContent = d.total_clicks.toLocaleString();
    document.getElementById('stat-7d').textContent     = d.clicks_7d.toLocaleString();
    document.getElementById('stat-avg').textContent    = d.total_links>0 ? (d.total_clicks/d.total_links).toFixed(1) : '0';
  } catch(e) {}
}

async function loadTags() {
  try {
    const d = await (await authFetch(`${BASE}/api/tags`)).json();
    allTags = d.tags || [];
    renderTagFilters();
  } catch(e) {}
}

function renderTagFilters() {
  const container = document.getElementById('tag-filter-list');
  container.innerHTML = '';
  allTags.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'tag-filter-btn' + (activeTag===t.name?' active':'');
    btn.textContent = `${t.name} (${t.link_count})`;
    btn.onclick = () => { activeTag = activeTag===t.name?null:t.name; renderTagFilters(); loadLinks(); };
    container.appendChild(btn);
  });
}

async function loadLinks() {
  const q = document.getElementById('search-input').value.trim();
  let url = `${BASE}/api/links?per_page=50`;
  if (q)         url += `&q=${encodeURIComponent(q)}`;
  if (activeTag) url += `&tag=${encodeURIComponent(activeTag)}`;
  try {
    const d = await (await authFetch(url)).json();
    renderLinks(d.links || []);
  } catch(e) {
    document.getElementById('links-list').innerHTML='<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Could not load</p></div>';
  }
}

document.getElementById('search-input').addEventListener('input', () => {
  clearTimeout(searchTimer); searchTimer = setTimeout(loadLinks, 300);
});

function renderLinks(links) {
  const container = document.getElementById('links-list');
  if (!links.length) { container.innerHTML='<div class="empty-state"><div class="empty-icon">üîó</div><p>No links found</p></div>'; return; }
  container.innerHTML='';
  links.forEach(l => container.appendChild(buildLinkItem(l)));
}

function buildLinkItem(l) {
  const item = document.createElement('div');
  item.className = 'link-item';
  item.id = `item-${l.code}`;
  const tagPills = (l.tags||[]).map(t=>`<span class="link-tag">${t.name}</span>`).join('');
  const expNote  = l.expires_at ? `<span style="font-size:10px;color:var(--muted);font-family:var(--font-mono)"> ¬∑ exp ${l.expires_at.slice(0,10)}</span>`:'';
  const canEdit  = loggedIn;

  item.innerHTML = `
    <div class="link-row" onclick="toggleExpand('${l.code}')">
      <div class="select-check" style="display:${selectMode?'flex':'none'}">
        <input type="checkbox" class="link-checkbox" id="chk-${l.code}"
               ${selectedCodes.has(l.code)?'checked':''} onclick="event.stopPropagation()"
               onchange="toggleSelect('${l.code}')">
      </div>
      <div class="link-code">${l.code}</div>
      <div class="link-details">
        <div class="link-title">${escHtml(l.title||l.long_url)}</div>
        <div class="link-original">${escHtml(l.long_url)}</div>
        ${tagPills?`<div class="link-tags">${tagPills}</div>`:''}
      </div>
      <div class="link-meta">
        <div class="link-clicks"><strong>${l.clicks}</strong> clicks${expNote}</div>
        <svg class="link-chevron" width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M2 5L7 10L12 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </div>
    </div>
    <div class="link-expanded" id="exp-${l.code}">
      <div class="expanded-actions">
        <button class="btn-sm" onclick="copyToClipboard('${l.short_url}')">Copy link</button>
        ${canEdit?`<button class="btn-sm" onclick="toggleEdit('${l.code}')">‚úé Edit</button>`:''}
        <button class="btn-sm" onclick="window.open('${l.qr_url}')">‚Üì QR</button>
        ${canEdit?`<button class="btn-sm danger" onclick="deleteLink('${l.code}')">‚úï Delete</button>`:''}
      </div>
      ${canEdit?`
      <div class="edit-form" id="edit-${l.code}">
        <h4>EDIT LINK</h4>
        <div class="edit-grid">
          <div class="edit-full"><label class="field-label">DESTINATION URL</label><input class="field-input" id="edit-url-${l.code}" value="${escHtml(l.long_url)}"></div>
          <div><label class="field-label">TITLE</label><input class="field-input" id="edit-title-${l.code}" value="${escHtml(l.title||'')}"></div>
          <div><label class="field-label">EXPIRY DATE</label><input class="field-input" type="date" id="edit-expiry-${l.code}" value="${(l.expires_at||'').slice(0,10)}"></div>
          <div class="edit-full"><label class="field-label">TAGS (comma separated)</label><input class="field-input" id="edit-tags-${l.code}" value="${(l.tags||[]).map(t=>t.name).join(', ')}"></div>
        </div>
        <div class="edit-actions">
          <button class="btn-sm" onclick="toggleEdit('${l.code}')">Cancel</button>
          <button class="btn-sm save" onclick="saveEdit('${l.code}')">Save</button>
        </div>
      </div>`:''}
      <div class="analytics-wrap" id="analytics-${l.code}">
        <div class="analytics-header">
          <div class="analytics-title">CLICK ANALYTICS</div>
          <div class="analytics-days">
            <button class="day-btn active" onclick="loadAnalytics('${l.code}',7,this)">7d</button>
            <button class="day-btn" onclick="loadAnalytics('${l.code}',30,this)">30d</button>
            <button class="day-btn" onclick="loadAnalytics('${l.code}',90,this)">90d</button>
          </div>
        </div>
        <div id="analytics-content-${l.code}"><div style="color:var(--muted);font-size:12px;font-family:var(--font-mono)">Expand to load analytics</div></div>
      </div>
    </div>`;
  return item;
}

function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

async function toggleExpand(code) {
  const item = document.getElementById(`item-${code}`);
  const was  = item.classList.contains('expanded');
  item.classList.toggle('expanded');
  if (!was) loadAnalytics(code, 7);
}
function toggleEdit(code) { document.getElementById(`edit-${code}`)?.classList.toggle('open'); }

async function saveEdit(code) {
  const url    = document.getElementById(`edit-url-${code}`).value.trim();
  const title  = document.getElementById(`edit-title-${code}`).value.trim();
  const expiry = document.getElementById(`edit-expiry-${code}`).value;
  const tags   = document.getElementById(`edit-tags-${code}`).value.split(',').map(t=>t.trim()).filter(Boolean);
  const resp = await authFetch(`${BASE}/api/links/${code}`, {method:'PATCH',body:JSON.stringify({url,title,expires_at:expiry||null,tags})});
  const data = await resp.json();
  if (!resp.ok) { toast(data.error||'Save failed','error'); return; }
  toast('Link updated!');
  const old = document.getElementById(`item-${code}`);
  const fresh = buildLinkItem(data);
  fresh.classList.add('expanded');
  old.parentNode.replaceChild(fresh, old);
  loadStats(); loadTags();
}

async function deleteLink(code) {
  if (!confirm(`Delete /${code}?`)) return;
  await authFetch(`${BASE}/api/links/${code}`, {method:'DELETE'});
  document.getElementById(`item-${code}`)?.remove();
  toast('Deleted'); loadStats();
}

function copyToClipboard(url) { navigator.clipboard.writeText(url); toast('Copied!'); }

// ‚îÄ‚îÄ Analytics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAnalytics(code, days, btnEl) {
  if (btnEl) {
    document.querySelectorAll(`#analytics-${code} .day-btn`).forEach(b=>b.classList.remove('active'));
    btnEl.classList.add('active');
  }
  const container = document.getElementById(`analytics-content-${code}`);
  container.innerHTML = '<div style="color:var(--muted);font-size:12px;font-family:var(--font-mono);padding:10px 0">Loading...</div>';
  try {
    const d = await (await authFetch(`${BASE}/api/links/${code}/analytics?days=${days}`)).json();
    renderAnalytics(code, d);
  } catch(e) { container.innerHTML='<div style="color:var(--muted);font-size:12px;font-family:var(--font-mono)">Could not load</div>'; }
}

function renderAnalytics(code, d) {
  const container = document.getElementById(`analytics-content-${code}`);
  const chartId   = `chart-${code}`;
  container.innerHTML = `
    <div class="chart-wrap"><canvas class="chart-canvas" id="${chartId}" height="90"></canvas></div>
    <div class="breakdown-grid">
      <div class="breakdown-card"><h5>REFERRERS</h5>${renderBreakdown(d.referrers.map(r=>({label:r.source,count:r.count})))}</div>
      <div class="breakdown-card"><h5>DEVICES</h5>${renderBreakdown(d.devices.map(r=>({label:r.device,count:r.count})))}</div>
      <div class="breakdown-card"><h5>BROWSERS</h5>${renderBreakdown(d.browsers.map(r=>({label:r.browser,count:r.count})))}</div>
    </div>`;
  requestAnimationFrame(() => {
    const canvas = document.getElementById(chartId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio||1;
    const W   = canvas.offsetWidth, H = 90;
    canvas.width = W*dpr; canvas.height = H*dpr; ctx.scale(dpr,dpr);
    const data = d.daily, n = data.length;
    const max  = Math.max(...data.map(x=>x.clicks),1);
    const barW = Math.max(2,(W/n)-2);
    const gap  = (W-barW*n)/(n-1||1);
    data.forEach((pt,i) => {
      const x = i*(barW+gap), bH = (pt.clicks/max)*(H-14), y = H-bH-2;
      ctx.fillStyle = `rgba(0,229,160,${pt.clicks>0?.8:.15})`;
      ctx.beginPath(); ctx.roundRect(x,y,barW,bH+2,[2,2,0,0]); ctx.fill();
    });
    ctx.fillStyle='rgba(107,107,128,.8)'; ctx.font=`10px "Share Tech Mono"`;
    if (data.length>0) {
      ctx.textAlign='left';   ctx.fillText(data[0].date.slice(5),0,H);
      ctx.textAlign='right';  ctx.fillText(data[data.length-1].date.slice(5),W,H);
    }
  });
}

function renderBreakdown(rows) {
  if (!rows.length) return '<div style="color:var(--muted);font-size:11px;font-family:var(--font-mono)">No data</div>';
  const max = Math.max(...rows.map(r=>r.count));
  return rows.map(r=>`
    <div class="breakdown-row">
      <div class="breakdown-label">${escHtml(r.label)}</div>
      <div class="breakdown-bar-wrap"><div class="breakdown-bar" style="width:${Math.round((r.count/max)*100)}%"></div></div>
      <div class="breakdown-count">${r.count}</div>
    </div>`).join('');
}

// ‚îÄ‚îÄ Shorten ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('adv-toggle').addEventListener('click', function() { this.classList.toggle('open'); document.getElementById('adv-fields').classList.toggle('open'); });
document.getElementById('shorten-btn').addEventListener('click', doShorten);
document.getElementById('url-input').addEventListener('keydown', e=>{ if(e.key==='Enter') doShorten(); });

// Tag input
const tagInputEl = document.getElementById('tag-input');
document.getElementById('tag-input-wrap').addEventListener('click',()=>tagInputEl.focus());
tagInputEl.addEventListener('keydown', e=>{
  if(e.key==='Enter'||e.key===','){e.preventDefault();addTagPill(tagInputEl.value.trim().replace(/,$/,''));tagInputEl.value='';}
  else if(e.key==='Backspace'&&tagInputEl.value===''&&tagInputTags.length>0){removeTagPill(tagInputTags[tagInputTags.length-1]);}
});
tagInputEl.addEventListener('blur',()=>{ if(tagInputEl.value.trim()){addTagPill(tagInputEl.value.trim());tagInputEl.value='';} });

function addTagPill(name) {
  name = name.toLowerCase().replace(/[^a-z0-9-_]/g,'');
  if(!name||tagInputTags.includes(name))return;
  tagInputTags.push(name); renderTagPills();
}
function removeTagPill(name) { tagInputTags=tagInputTags.filter(t=>t!==name); renderTagPills(); }
function renderTagPills() {
  const wrap = document.getElementById('tag-input-wrap');
  wrap.querySelectorAll('.tag-pill').forEach(e=>e.remove());
  tagInputTags.forEach(name=>{
    const pill=document.createElement('div'); pill.className='tag-pill';
    pill.innerHTML=`${name}<button onclick="removeTagPill('${name}')">√ó</button>`;
    wrap.insertBefore(pill,tagInputEl);
  });
}

async function doShorten() {
  const url    = document.getElementById('url-input').value.trim();
  const code   = document.getElementById('custom-code').value.trim();
  const title  = document.getElementById('link-title').value.trim();
  const expiry = document.getElementById('link-expiry').value;
  if (!url) { toast('Please enter a URL','error'); return; }
  const btn=document.getElementById('shorten-btn'), lbl=document.getElementById('shorten-label');
  btn.disabled=true; lbl.innerHTML='<span class="spinner"></span>';
  try {
    const resp = await authFetch(`${BASE}/api/shorten`,{method:'POST',body:JSON.stringify({
      url, custom_code:code, title, expires_at:expiry||null, tags:tagInputTags
    })});
    const data = await resp.json();
    if(!resp.ok){toast(data.error||'Error','error');return;}
    showResult(data); toast('Link shortened!');
    tagInputTags=[]; renderTagPills();
  } catch(e){toast('Network error','error');}
  finally{btn.disabled=false;lbl.textContent='Snip it ‚Üí';}
}

function showResult(data) {
  const card=document.getElementById('result-card');
  document.getElementById('result-url').href=data.short_url;
  document.getElementById('result-url').textContent=data.short_url;
  document.getElementById('result-original').textContent=data.long_url;
  document.getElementById('result-qr-img').src=data.qr_url+'?t='+Date.now();
  card.classList.add('visible');
  document.getElementById('copy-btn').onclick=()=>{navigator.clipboard.writeText(data.short_url);toast('Copied!');};
  document.getElementById('dl-qr-btn').onclick=()=>{const a=document.createElement('a');a.href=data.qr_url;a.download=`qr-${data.code}.png`;a.click();};
  document.getElementById('customize-qr-btn').onclick=()=>{document.getElementById('qr-url-input').value=data.short_url;showView('qr');};
}

// ‚îÄ‚îÄ QR Generator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const qrFgP=document.getElementById('qr-fg-picker'), qrBgP=document.getElementById('qr-bg-picker');
const qrFgH=document.getElementById('qr-fg-hex'),    qrBgH=document.getElementById('qr-bg-hex');
const qrSz =document.getElementById('qr-size');
qrFgP.addEventListener('input',()=>qrFgH.value=qrFgP.value.replace('#',''));
qrBgP.addEventListener('input',()=>qrBgH.value=qrBgP.value.replace('#',''));
qrFgH.addEventListener('input',()=>{ if(qrFgH.value.length===6) qrFgP.value='#'+qrFgH.value; });
qrBgH.addEventListener('input',()=>{ if(qrBgH.value.length===6) qrBgP.value='#'+qrBgH.value; });
qrSz.addEventListener('input',()=>document.getElementById('qr-size-label').textContent=qrSz.value+'px');

// QR style selector
document.querySelectorAll('#qr-style-selector .style-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#qr-style-selector .style-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    qrStyle = btn.dataset.style;
  });
});

// Logo upload
document.getElementById('qr-logo-input').addEventListener('change', function() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    qrLogoBase64 = e.target.result.split(',')[1];
    document.getElementById('qr-logo-name').textContent = file.name;
    document.getElementById('qr-logo-clear').style.display = 'inline-block';
  };
  reader.readAsDataURL(file);
});
function clearQrLogo() {
  qrLogoBase64 = null;
  document.getElementById('qr-logo-input').value = '';
  document.getElementById('qr-logo-name').textContent = '';
  document.getElementById('qr-logo-clear').style.display = 'none';
}

document.getElementById('qr-generate-btn').addEventListener('click', async () => {
  const url = document.getElementById('qr-url-input').value.trim();
  if (!url) { toast('Please enter a URL','error'); return; }
  const fg   = qrFgH.value.replace('#','') || '000000';
  const bg   = qrBgH.value.replace('#','') || 'ffffff';
  const size = parseInt(qrSz.value);
  const btn  = document.getElementById('qr-generate-btn');

  if (qrLogoBase64 || qrStyle !== 'square') {
    btn.disabled = true; btn.textContent = 'Generating...';
    try {
      const body = { url, fg, bg, size, style: qrStyle };
      if (qrLogoBase64) body.logo = qrLogoBase64;
      const resp = await authFetch(`${BASE}/api/qr/custom`, {method:'POST', body:JSON.stringify(body)});
      if (!resp.ok) { toast('Failed to generate QR','error'); return; }
      const blob   = await resp.blob();
      const blobUrl = URL.createObjectURL(blob);
      document.getElementById('qr-preview-wrap').innerHTML =
        `<div class="qr-preview-img"><img src="${blobUrl}" width="${Math.min(size,300)}" height="${Math.min(size,300)}" alt="QR"></div>`;
      document.getElementById('qr-dl-row').style.display = 'flex';
      document.getElementById('qr-download-link').href = blobUrl;
    } catch(e) { toast('Network error','error'); }
    finally { btn.disabled = false; btn.textContent = 'Generate QR Code'; }
  } else {
    const qrUrl = `${BASE}/api/qr/custom?url=${encodeURIComponent(url)}&fg=${fg}&bg=${bg}&size=${size}&t=${Date.now()}`;
    document.getElementById('qr-preview-wrap').innerHTML =
      `<div class="qr-preview-img"><img src="${qrUrl}" width="${Math.min(size,300)}" height="${Math.min(size,300)}" alt="QR"></div>`;
    document.getElementById('qr-dl-row').style.display = 'flex';
    document.getElementById('qr-download-link').href = qrUrl;
  }
  toast('QR generated!');
});

// ‚îÄ‚îÄ Select Mode & Bulk Ops ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSelectMode() {
  selectMode = !selectMode;
  selectedCodes.clear();
  const btn = document.getElementById('select-btn');
  btn.classList.toggle('active', selectMode);
  btn.textContent = selectMode ? '‚úì Selecting' : '‚ä° Select';
  document.querySelectorAll('.select-check').forEach(el => {
    el.style.display = selectMode ? 'flex' : 'none';
  });
  document.querySelectorAll('.link-checkbox').forEach(el => { el.checked = false; });
  updateBulkBar();
}

function toggleSelect(code) {
  if (selectedCodes.has(code)) selectedCodes.delete(code);
  else selectedCodes.add(code);
  updateBulkBar();
}

function selectAll() {
  const checkboxes = document.querySelectorAll('.link-checkbox');
  const allChecked = [...checkboxes].every(cb => cb.checked);
  checkboxes.forEach(cb => {
    cb.checked = !allChecked;
    const code = cb.id.replace('chk-', '');
    if (!allChecked) selectedCodes.add(code); else selectedCodes.delete(code);
  });
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  if (selectMode && selectedCodes.size > 0) {
    bar.style.display = 'flex';
    document.getElementById('bulk-count').textContent = `${selectedCodes.size} selected`;
  } else {
    bar.style.display = 'none';
  }
}

async function bulkDelete() {
  if (!selectedCodes.size) return;
  if (!confirm(`Delete ${selectedCodes.size} link(s)?`)) return;
  const codes = [...selectedCodes];
  const resp = await authFetch(`${BASE}/api/links/bulk`, {method:'POST', body:JSON.stringify({action:'delete', codes})});
  if (!resp.ok) { toast('Bulk delete failed','error'); return; }
  codes.forEach(c => document.getElementById(`item-${c}`)?.remove());
  selectedCodes.clear(); updateBulkBar(); loadStats();
  toast(`Deleted ${codes.length} link(s)`);
}

async function bulkTag() {
  if (!selectedCodes.size) return;
  const input = prompt('Tags to apply (comma-separated):');
  if (!input) return;
  const tags  = input.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
  const codes = [...selectedCodes];
  const resp = await authFetch(`${BASE}/api/links/bulk`, {method:'POST', body:JSON.stringify({action:'tag', codes, tags})});
  if (!resp.ok) { toast('Bulk tag failed','error'); return; }
  selectedCodes.clear(); updateBulkBar(); loadDashboard();
  toast(`Tagged ${codes.length} link(s)`);
}

async function bulkExpire() {
  if (!selectedCodes.size) return;
  const dateVal = prompt('Expiry date (YYYY-MM-DD), blank to clear:');
  if (dateVal === null) return;
  const codes = [...selectedCodes];
  const resp = await authFetch(`${BASE}/api/links/bulk`, {method:'POST', body:JSON.stringify({action:'expire', codes, expires_at: dateVal||null})});
  if (!resp.ok) { toast('Bulk expire failed','error'); return; }
  selectedCodes.clear(); updateBulkBar(); loadDashboard();
  toast(`Updated ${codes.length} link(s)`);
}

// ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportCSV() {
  const resp = await authFetch(`${BASE}/api/links/export`);
  if (!resp.ok) { toast('Export failed','error'); return; }
  const blob = await resp.blob();
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = 'sniplink-export.csv'; a.click();
  URL.revokeObjectURL(url);
  toast('Export downloaded!');
}

// ‚îÄ‚îÄ CSV Import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleImport() {
  document.getElementById('import-panel').classList.toggle('open');
}

document.getElementById('import-file').addEventListener('change', function() {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => { document.getElementById('import-csv').value = e.target.result; };
  reader.readAsText(file);
});

async function doImport() {
  const csv = document.getElementById('import-csv').value.trim();
  if (!csv) { toast('Paste CSV data first','error'); return; }
  const btn = document.getElementById('import-btn');
  btn.disabled = true; btn.textContent = 'Importing...';
  try {
    const resp = await authFetch(`${BASE}/api/links/import`, {method:'POST', body:JSON.stringify({csv})});
    const data = await resp.json();
    if (!resp.ok) { toast(data.error||'Import failed','error'); return; }
    const resultEl = document.getElementById('import-result');
    let msg = `‚úì Created ${data.created} link(s)`;
    if (data.errors.length) { msg += `\n‚úï Errors:\n` + data.errors.join('\n'); }
    resultEl.textContent = msg;
    toast(`Imported ${data.created} link(s)`, data.errors.length ? 'error' : 'success');
    if (data.created > 0) loadDashboard();
  } catch(e) { toast('Network error','error'); }
  finally { btn.disabled = false; btn.textContent = 'Import'; }
}

// ‚îÄ‚îÄ Debug panel (activated by ?debug=1 in URL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (new URLSearchParams(window.location.search).get('debug') === '1') {
  document.getElementById('debug-panel').style.display = 'block';
  runDebug();
}
async function runDebug() {
  const panel = document.getElementById('dbg-content');
  panel.innerHTML = [
    `<b>window.location.origin:</b> ${window.location.origin}`,
    `<b>loggedIn:</b> ${loggedIn}`,
  ].join('<br>');
  try {
    const r = await fetch(`${BASE}/api/auth/me`, {credentials:'include'});
    document.getElementById('dbg-extra').textContent = `/api/auth/me ‚Üí HTTP ${r.status}`;
  } catch(e) {
    document.getElementById('dbg-extra').textContent = 'Failed: ' + e;
  }
}
async function testStats() {
  const extra = document.getElementById('dbg-extra');
  try {
    const r = await authFetch(`${BASE}/api/stats`);
    const body = await r.text();
    extra.textContent = `/api/stats ‚Üí HTTP ${r.status}\n${body.slice(0,500)}`;
  } catch(e) {
    extra.textContent = 'Error: ' + e;
  }
}
</script>
</body>
</html>
